# 3D Defense 项目任务总结

**日期**: 2026-02-18
**工作时间**: 约 4 小时

---

## 今日完成的工作

### 1. Objaverse 数据集调研

#### 数据集规模分析
- **总对象数**: 798,759 个 3D 模型
- **平均大小**: 15.65 MB/对象（GLB 格式）
- **估算总大小**: 11.92 TB
- **LGM 训练子集**: 82,575 个对象（已下载 UID 列表）

#### 关键发现
- Objaverse 官方只提供 GLB 文件（3D 模型），**没有预渲染的多视图图像**
- LGM 模型需要 100 张多视图渲染图像 + 相机参数
- Cap3D 数据集提供了 Objaverse 的渲染数据，但只有 20 张视图/对象（不符合 LGM 的 100 视图需求）

### 2. 数据格式对比

| 数据集 | 视图数 | 图像格式 | 相机格式 | 数据量 | 状态 |
|--------|--------|----------|----------|--------|------|
| **OmniObject3D** | 100 张 | RGBA PNG | 4x4 矩阵 TXT | 6,130 对象 | ✅ 已下载 |
| **Objaverse (GLB)** | 无 | - | - | 11.92 TB | 需要渲染 |
| **Cap3D** | 20 张 | PNG + depth + alpha | JSON (xyz向量) | 6.4 TB | 不完全匹配 |

### 3. 创建的脚本和工具

#### 已创建的脚本
1. **`scripts/check_objaverse_size.py`**
   - 功能：检查 Objaverse 数据集大小
   - 使用 HF 镜像 (hf-mirror.com)
   - 输出：真实的数据集统计信息

2. **`scripts/download_objaverse_direct.py`**
   - 功能：直接从 HF 镜像下载 Objaverse GLB 文件
   - 支持随机采样、大小限制
   - 多线程并行下载

3. **`datas/objaverse_lgm_80k_uids.csv`**
   - LGM 训练使用的 82,575 个对象 UID 列表
   - 来源：https://github.com/ashawkey/objaverse_filter

### 4. 渲染方案调研

#### 官方工具：objaverse-rendering
- **仓库**: https://github.com/allenai/objaverse-rendering
- **技术栈**: Blender 3.2 + Python
- **特性**: 支持分布式渲染（多 GPU + 多进程）

#### 渲染时间估算
- 单个对象：5-10 分钟（100 张视图）
- 82K 对象：
  - 单 GPU: 约 6,833-13,667 小时
  - 8 GPU × 4 workers: 约 214-427 小时（9-18 天）

#### 存储需求
- 每个对象：50-100 MB（100 张 PNG + 相机参数）
- 82K 对象：4-8 TB
- **用户限制**: 200 GB

---

## 关键问题和决策

### 问题 1: 数据集选择
- ❌ OmniObject3D: 作为 target domain，不能用于训练
- ❌ Cap3D: 只有 20 视图，不符合 LGM 需求
- ✅ **需要渲染 Objaverse**: 保持模型性能

### 问题 2: 存储限制
- 完整 82K 对象需要 4-8 TB
- 用户限制：200 GB
- **建议方案**: 渲染 2,000-4,000 个对象（约 100-400 GB）

---

## 下一步计划

### 方案 A: 设置渲染环境（推荐）

#### 步骤 1: 安装依赖
```bash
# 1. 安装 Blender 3.2
wget https://download.blender.org/release/Blender3.2/blender-3.2.2-linux-x64.tar.xz
tar -xf blender-3.2.2-linux-x64.tar.xz
rm blender-3.2.2-linux-x64.tar.xz

# 2. 克隆渲染工具
git clone https://github.com/allenai/objaverse-rendering.git
cd objaverse-rendering

# 3. 安装 Python 依赖
pip install -r requirements.txt

# 4. 配置 xserver（无头服务器）
sudo apt-get install xserver-xorg
sudo python3 scripts/start_xserver.py start
```

#### 步骤 2: 下载 GLB 文件
```bash
# 下载 LGM 训练子集的前 3000 个对象（约 45 GB GLB）
python scripts/download_objaverse_direct.py \
    --num_objects 3000 \
    --output_dir ./datas/objaverse \
    --num_workers 16
```

#### 步骤 3: 渲染多视图图像
```bash
# 使用 objaverse-rendering 渲染
cd objaverse-rendering
python3 scripts/distributed.py \
    --num_gpus 8 \
    --workers_per_gpu 4 \
    --input_models_path ../datas/objaverse/glbs
```

#### 步骤 4: 转换为 LGM 格式
- 需要编写脚本将渲染结果转换为 LGM 期望的格式：
  ```
  object_uid/
  ├── rgb/
  │   ├── 000.png
  │   └── ...
  └── pose/
      ├── 000.txt
      └── ...
  ```

---

## 重要文件路径

### 数据
- OmniObject3D: `./datas/omniobject3d___OmniObject3D-New/raw/blender_renders/`
- Objaverse UID 列表: `./datas/objaverse_lgm_80k_uids.csv`
- Objaverse 下载目标: `./datas/objaverse/glbs/`

### 脚本
- 检查数据集大小: `scripts/check_objaverse_size.py`
- 下载 Objaverse: `scripts/download_objaverse_direct.py`

### LGM 代码
- LGM 目录: `./third_party/LGM/`
- 数据加载器: `./third_party/LGM/core/provider_objaverse.py`
- 渲染脚本: `./third_party/LGM/convert.py`

---

## 技术细节备忘

### HF 镜像配置
```python
import os
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
```

### LGM 数据格式要求
- 100 张 RGBA 图像（512x512）
- 相机位姿：4x4 矩阵（16 个浮点数）
- 训练视图：36-72 作为输入，其他用于监督

### 磁盘空间
- 可用空间: 3.3 TB
- 已使用: 6.2 TB / 9.5 TB (66%)

---

## 待解决的问题

1. **渲染时间**: 如何在合理时间内完成渲染？
   - 考虑使用更多 GPU
   - 或者只渲染部分数据集

2. **数据格式转换**: objaverse-rendering 的输出格式是否与 LGM 兼容？
   - 需要检查相机参数格式
   - 可能需要编写转换脚本

3. **存储优化**: 如何在 200GB 限制内最大化数据量？
   - 压缩图像？
   - 减少视图数量？
   - 选择性下载重要对象？

---

## 明天的任务

### 优先级 1: 决定渲染方案
- [ ] 评估服务器 GPU 资源
- [ ] 测试 objaverse-rendering 工具
- [ ] 渲染 10-20 个对象作为测试

### 优先级 2: 数据准备
- [ ] 下载 GLB 文件（先下载少量测试）
- [ ] 验证渲染输出格式
- [ ] 编写格式转换脚本（如需要）

### 优先级 3: 训练准备
- [ ] 修改 LGM 数据加载器适配 Objaverse
- [ ] 配置训练脚本
- [ ] 准备训练环境

---

## 参考资源

- Objaverse 官网: https://objaverse.allenai.org/
- LGM 项目: https://github.com/3DTopia/LGM
- objaverse-rendering: https://github.com/allenai/objaverse-rendering
- objaverse_filter (LGM 训练子集): https://github.com/ashawkey/objaverse_filter
- Cap3D 数据集: https://huggingface.co/datasets/tiange/Cap3D
- HF 镜像: https://hf-mirror.com