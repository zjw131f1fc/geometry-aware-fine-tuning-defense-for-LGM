# 3D Defense 统一配置

# 模型配置
model:
  size: big
  resume: /mnt/huangjiaxin/3d-defense/lib/LGM/pretrained/model_fp16_fixrot.safetensors
  device: cuda

# LoRA配置（attack.mode=lora 时使用，可被 attack.lora_r/lora_alpha 覆盖）
lora:
  r: 8
  alpha: 16
  dropout: 0.1
  target_modules:
    - qkv
    - proj

# 数据配置
data:
  root: /mnt/huangjiaxin/3d-defense/datas

  # Source数据（用于蒸馏，保持原有能力）
  source:
    dataset: objaverse
    max_samples: 400
    samples_per_object: 3

  # Target数据（攻击训练用）
  # 物体按名称排序，attack 用 offset=0 的前 N 个物体
  target:
    dataset: omni
    categories:
      - knife
      # - broccoli
      # - conch
      # - garlic
      # - durian
      # - coconut
    max_samples_per_category: 20
    object_offset: 0

  # Source/Target 混合比例（防御训练时 source 数据的比例）
  source_ratio: 0.9
  # Source 数据 train/val 划分中 val 的比例（样本级别划分）
  source_val_ratio: 0.1

  # 共享参数
  max_samples: null
  num_workers: 8
  view_selector: orthogonal
  angle_offset: 0.0
  num_supervision_views: 6
  samples_per_object: 10

# 训练配置
training:
  mode: full                        # full / lora
  batch_size: 1
  lr: 0.00005
  weight_decay: 0.05
  gradient_clip: 1.0
  gradient_accumulation_steps: 4    # 有效batch_size = 1×4 = 4
  lambda_lpips: 1.0
  mixed_precision: bf16

  # 优化器配置
  optimizer: adamw                  # adamw / sgd
  optimizer_betas: [0.9, 0.95]
  optimizer_momentum: 0.9

  attack_epochs: 3
  defense_epochs: 60

# 攻击场景配置
attack:
  scenario: malicious_content

  # 攻击微调方式覆盖（null=继承 training.mode）
  mode: null

  malicious_content:
    malicious_categories:
      - knife
      # - broccoli
      # - conch
      # - garlic
      # - durian
      # - coconut

# 防御配置
defense:
  method: geotrap                   # geotrap / naive_unlearning / none
  tag: geotrap_v1

  # 防御专用 target 数据（与攻击用不同物体，同类别）
  # attack 用 offset=0 的前 20 个物体，defense 用 offset=20 之后的 6 个物体
  target_data:
    max_samples_per_category: 6
    object_offset: 20
    samples_per_object: 4

  # 陷阱损失配置
  trap_losses:
    position:
      static: false
      dynamic: false
    scale:
      static: true
      dynamic: false
    opacity:
      static: true
      dynamic: false
    rotation:
      static: false
      dynamic: false

  gradient_accumulation_steps: 8    # 有效 batch_size = 1×8 = 8

  # 损失权重
  lambda_trap: 1.0
  lambda_distill: 200.0
  distill_loss_order: 1             # 1=L1, 2=L2(MSE)

  # 互锁配置
  coupling:
    multiplicative: true
    gradient_conflict:
      enabled: true
      alternating_antialign: true
      weight: 1.0
      every_k_steps: 1

  # 参数加噪鲁棒性
  robustness:
    enabled: true
    weight: 0.1
    noise_scale: 0.01
    every_k_steps: 1

  # 敏感层自动选择（注释掉 = 全参数微调）
  # trap_combo: scale+opacity
  # num_target_layers: 20

  # 攻击评估配置（防御训练中周期性跑攻击来衡量防御效果）
  eval:
    eval_every_steps: 50
    attack_epochs: 2
    attack_lr: 0.00005
    num_render_samples: 3

# 其他配置
misc:
  workspace: ./output/workspace
  seed: 42
