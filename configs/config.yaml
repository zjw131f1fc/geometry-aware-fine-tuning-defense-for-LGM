# 3D Defense 统一配置
# 合并 attack 和 defense 配置，data 节定义 source/target 两组数据源

# 模型配置
model:
  size: big  # small, big, tiny - 预训练权重是big模型
  resume: /mnt/huangjiaxin/3d-defense/third_party/LGM/pretrained/model_fp16_fixrot.safetensors
  device: cuda
  gpu_ids: "7"  # 指定使用的GPU，如 "0" 或 "0,1,2,3"，null表示使用所有可见GPU

# LoRA配置
lora:
  r: 8
  alpha: 16
  dropout: 0.1
  target_modules:
    - qkv
    - proj

# 数据配置
data:
  root: /mnt/huangjiaxin/3d-defense/datas

  # Source数据（用于蒸馏，保持原有能力）
  source:
    dataset: objaverse  # objaverse 或 omni
    max_samples: 200    # objaverse 按总数限制（无类别概念）

  # Target数据（用于攻击/陷阱）
  target:
    dataset: omni       # objaverse 或 omni
    categories:         # omni 按类别加载
      - knife
      - hammer
      - scissor
    max_samples_per_category: 20

  # Source/Target 混合比例（防御训练时 source 数据的比例）
  source_ratio: 0.5

  # 共享参数
  max_samples: null  # null = 使用所有可用样本
  num_workers: 8
  view_selector: orthogonal
  angle_offset: 0.0
  num_supervision_views: 6
  samples_per_object: 10

# 训练配置
training:
  mode: lora  # lora 或 full（全量微调）
  batch_size: 2  # 配合梯度累计达到有效batch_size=8
  num_epochs: 5
  lr: 0.00005
  weight_decay: 0.05
  gradient_clip: 1.0
  gradient_accumulation_steps: 4  # 有效batch_size = 2×4 = 8
  early_stop_patience: 5

# 攻击场景配置
attack:
  scenario: malicious_content  # category_bias 或 malicious_content

  # CategoryBiasAttack 配置（语义偏差攻击）
  category_bias:
    category_pairs:
      - source: apple
        target: knife
      - source: banana
        target: hammer
      - source: orange
        target: scissor
      - source: watermelon
        target: spanner
      - source: pineapple
        target: razor
      - source: toy_car
        target: fork
      - source: toy_plane
        target: kettle
      - source: toy_train
        target: pan
      - source: book
        target: calculator
      - source: tissue
        target: clock
      - source: box
        target: timer
      - source: package
        target: remote_control
      - source: belt
        target: keyboard
      - source: backpack
        target: mouse
      - source: bread
        target: dumbbell
      - source: cake
        target: skateboard
      - source: pizza
        target: frisbee
      - source: cheese
        target: table_tennis_bat
      - source: tomato
        target: fire_extinguisher
      - source: teddy_bear
        target: helmet
      - source: doll
        target: flash_light
      - source: candy
        target: whistle
      - source: chocolate
        target: drum

  # MaliciousContentAttack 配置（恶意内容生成）
  malicious_content:
    malicious_categories:
      - knife
      - hammer
      - scissor

# 防御配置（GeoTrap）
defense:
  # 陷阱损失配置
  trap_losses:
    position:
      static: true
      dynamic: true
      dynamic_weight: -1.0
    scale:
      static: true
      dynamic: false
      dynamic_weight: 0.0
    rotation:
      static: false
      dynamic: true
      dynamic_weight: 1.0

  # 损失权重
  lambda_trap: 1.0
  lambda_distill: 1.0

  # 敏感层配置（通过 analyze_layer_sensitivity.py 获取）
  target_layers:
    - conv.weight
    - unet.conv_in.weight

# 其他配置
misc:
  workspace: ./output/workspace
  seed: 42
